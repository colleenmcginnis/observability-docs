---
id: enObservabilityMonitorGcp
slug: /en/observability/monitor-gcp
title: Monitor Google Cloud Platform
description: Description to be written
tags: []
---

import SharedInstallConfigureMetricbeat from './shared/install-configure-metricbeat.mdx'
import SharedInstallConfigureFilebeat from './shared/install-configure-filebeat.mdx'
import TransclusionGcpTopic from './gcp-topic.mdx'

<div id="monitor-gcp"></div>

In this tutorial, you'll learn how to monitor your Google Cloud Platform (GCP)
deployments using Elastic ((observability)): Logs and Infrastructure metrics.

<DocCallOut title="Note">

If you don't want to provision VM and install data shippers due to process and
management overhead, you can skip this step and ingest logs directly from
Pub/Sub in the Google Cloud Console to Elastic with
link:gcp-dataflow.html[GCP Dataflow Templates].

</DocCallOut>

<div id="what_you'll_learn"></div>

## What you'll learn

You'll learn how to:

- Set up a GCP Service Account.
- Ingest metrics using the [((metricbeat))
Google Cloud Platform module](((metricbeat-ref))/metricbeat-module-gcp.html) and view those metrics in ((kib)).
- Export GCP audit logs through Pub/Sub topics.
- Ingest logs using the [((filebeat))
Google Cloud module](((filebeat-ref))/filebeat-module-gcp.html) and view those logs in ((kib)).

<div id="before_you_begin"></div>

## Before you begin

Create a deployment using our hosted ((ess)) on [((ecloud))](((ess-trial))).
The deployment includes an ((es)) cluster for storing and searching your data,
and ((kib)) for visualizing and managing your data.

<div id="step_1:_setup_a_service_account"></div>

## Step 1: Setup a Service Account

Google Cloud Platform implements [service
accounts](https://cloud.google.com/compute/docs/access/service-accounts) as a way to access APIs securely. To monitor GCP with
Elastic, you will need a service account. The easiest way is to use a predefined
service account that GCP [creates automatically](https://cloud.google.com/compute/docs/access/service-accounts?hl=en#default_service_account).
Alternatively, you can create a new service account.
This tutorial creates a new one.

First, to access the service account menu, click
**Menu** -> **IAM & Admin** -> **Service Accounts**.

![Service account menu](images/monitor-gcp-service-account-menu.png)

Next, click **Create Service Account**. Define the new service account
name (for example, "gcp-monitor") and the description (for example, "Service
account to monitor GCP services using the ((stack))").

![Service account name](images/monitor-gcp-service-account-name.png)

<DocCallOut title="Important" color="warning">

Make sure to select the correct roles.

</DocCallOut>

To monitor GCP services, you need to add these roles to the
service account:

**Compute Viewer**:

![Service account roles compute viewer](images/monitor-gcp-service-account-roles-compute-viewer.png)

**Monitoring Viewer**:

![Service account roles monitoring viewer](images/monitor-gcp-service-account-roles-monitoring-viewer.png)

**Pub/Sub Subscriber**:

![Service account roles pub/sub subscriber](images/monitor-gcp-service-account-roles-pubsub-subscriber.png)

The final result should be the following:

![Service account roles result](images/monitor-gcp-service-account-roles-final.png)

Click **Continue**, then skip granting users access to this service. Finally,
click **Done**. The service account is now ready to be used.

Next, to use the service account, click **Manage keys**.

![Service account manage keys](images/monitor-gcp-service-account-manage-keys.png)

Then, add a new JSON key type by selecting **Create new key**.

![Service account create key](images/monitor-gcp-service-account-create-key.png)

After that, the credential file is downloaded.
Keep this file in an accessible place to use later.

<div id="step_2:_install_and_configure_((metricbeat))"></div>

## Step 2: Install and configure ((metricbeat))

<DocCallOut title="Note">

This tutorial assumes the Elastic cluster is already running. Make sure you have your **cloud ID** and your **credentials** on hand.

</DocCallOut>

To monitor GCP using the ((stack)), you need two main components:
an Elastic deployment to store and analyze the data and an agent to collect
and ship the data.

Two agents can be used to monitor GCP: ((metricbeat)) is used to
monitor metrics, and ((filebeat)) to monitor logs. You can run the agents on any
machine. This tutorial uses a small GCP instance, e2-small (2 vCPUs,
2 GB memory), with an Ubuntu distribution.

{leveloffset = "+3"}

<SharedInstallConfigureMetricbeat />
{leveloffset = "-3"}

Now that the output is working, you are going to set up the input (GCP).

<div id="step_3:_configure_((metricbeat))_google_cloud_platform_module"></div>

## Step 3: Configure ((metricbeat)) Google Cloud Platform module

To collect metrics from Google Cloud Platform, use the
[Google Cloud Platform](((metricbeat-ref))/metricbeat-module-gcp.html)
module. This module periodically fetches monitoring metrics from Google Cloud
Platform using
[Stackdriver Monitoring API](https://cloud.google.com/monitoring/api/metrics_gcp)
for Google Cloud Platform services.

<DocCallOut title="Warning" color="warning">

Extra GCP charges on Stackdriver Monitoring API requests may be generated by
this module. Please see
[rough estimation of the number of API calls](((metricbeat-ref))/metricbeat-module-gcp.html#gcp-api-requests)
for more details.

</DocCallOut>

1. Enable the GCP module.

    ```bash
    ./metricbeat modules enable gcp
    ```

1. Edit the `modules.d/gcp.yml` file to configure which metrics to
    collect.

    ```yml
    - module: gcp
    metricsets:
    - compute  [^1]
    zone: ""  [^2]
    project_id: "your-project-id"  [^3]
    period: 1m  [^4]
    credentials_file_path: "/home/ubuntu/credentials.json"  [^5]
    ```
    [^1]: The `compute` metricset is a predefined metricset that collects some
    GCP compute metrics.
    [^2]: Defines which zones to monitor, an empty value collects data from **all** zones
    [^3]: Collects metrics within the `your-project-id` project-id.
    [^4]: Collects metrics every minute
    [^5]: The GCP credential file that you generated earlier. (Don't forget to create
    the file if it does not exist and use the correct full path).

1. To check if ((metricbeat)) can collect data, test the input by running the
    following command:

    ```bash
    ./metricbeat test modules gcp
    ```

    ((metricbeat)) will print GCP metrics to the terminal, if the setup is correct.

1. When the input and output are ready, start ((metricbeat)) to collect the data.

    ```bash
    ./metricbeat -e
    ```

1. Finally, log into ((kib)) and open the **[((metricbeat)) GCP] Compute Overview**
    dashboard.

    ![((metricbeat)) compute overview dashboard](images/monitor-gcp-compute-overview-dashboard.png)

<div id="step_4:_install_and_configure_((filebeat))"></div>

## Step 4: Install and configure ((filebeat))

Now that ((metricbeat)) is up and running, configure ((filebeat)) to
collect Google Cloud logs.

export let leveloffset = "+3"

<SharedInstallConfigureFilebeat />
{leveloffset = "-3"}

Now that the output is working, you are going to set up the input (GCP).

<div id="step_5:_configure_((filebeat))_google_cloud_module"></div>

## Step 5: Configure ((filebeat)) Google Cloud module

To collect logs from Google Cloud Platform, use the
[Google Cloud Platform](((filebeat-ref))/filebeat-module-gcp.html)
module. This module periodically fetches logs that have been exported from
Stackdriver to a Google Pub/Sub topic sink.
<TransclusionGcpTopic />

1. Now that GCP is configured to export audit logs, enable ((filebeat)) Google Cloud module.

    ```bash
    ./filebeat modules enable gcp
    ```

1. Edit the `modules.d/gcp.yml` file with the following configurations.

    ```yml
    - module: gcp
      vpcflow:
      enabled: false  [^1]
      firewall:
      enabled: false  [^1]
      audit:
      enabled: true  [^2]
      var.project_id: "elastic-education"  [^3]
      var.topic: "monitor-gcp-audit"  [^4]
      var.subscription_name: "monitor-gcp-audit-sub"  [^5]
      var.credentials_file: "/home/ubuntu/credentials.json"  [^6]
    ```
    [^1]: Disables both `vpcflow` and `firewall` filesets.
    [^2]: Enables the `audit` fileset.
    [^3]: Collects data within the `elastic-education` project-id.
    [^4]: Collects logs from the `monitor-gcp-audit` topic.
    [^5]: Google Cloud Pub/Sub topic subscription name.
    [^6]: The GCP credential file that you generated earlier. (Don't forget to create
    the file if it does not exist and to use the correct full path).

1. Start ((filebeat)) to collect the logs.

    ```bash
    ./filebeat -e
    ```

1. Finally, log into ((kib)) and open the **[((filebeat)) GCP] Audit**
    dashboard.

    ![((filebeat)) audit overview dashboard](images/monitor-gcp-audit-overview-dashboard.png)

{/* The include that was here is another page */}
